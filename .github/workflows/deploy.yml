name: Deploy

on:
    push:
        branches: ["master"]

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.DO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

            - name: Deploy via SSH
              run: |
                  ssh deploy-user@${{ secrets.DO_HOST }} << 'EOF'

                    # Pull the latest code
                    cd ~/app/poker-planning-web
                    git pull origin master

                    # Install Docker Buildx if not already installed
                    if ! docker buildx version &>/dev/null; then
                      echo "Installing Docker Buildx..."
                      mkdir -p ~/.docker/cli-plugins
                      curl -SL https://github.com/docker/buildx/releases/latest/download/buildx-v0.12.1.linux-amd64 -o ~/.docker/cli-plugins/docker-buildx
                      chmod +x ~/.docker/cli-plugins/docker-buildx
                      docker buildx install
                    fi
                    
                    # Stop and remove the old container
                    docker stop poker-planning-web 2>/dev/null || true
                    docker rm poker-planning-web 2>/dev/null || true
                    
                    # Build the new image
                    DOCKER_BUILDKIT=1 docker build \
                      --build-arg BUILDKIT_INLINE_CACHE=1 \
                      -t poker-planning-web .

                    # Run the new container
                    docker run -d \
                      --name poker-planning-web \
                      --restart unless-stopped \
                      -p 3000:3000 \
                      --env-file .env \
                      poker-planning-web
                    
                    # Clean up old images
                    docker image prune -f
                  EOF
